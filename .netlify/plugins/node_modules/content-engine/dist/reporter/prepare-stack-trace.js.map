{"version":3,"file":"prepare-stack-trace.js","names":["ErrorWithCodeFrame","Error","codeFrame","constructor","error","message","Object","getOwnPropertyNames","forEach","key","prepareStackTrace","sourceOfMainMap","newError","bundleDir","path","dirname","bundleDirMapFiles","readdirSync","filter","fileName","endsWith","map","join","maps","source","TraceMap","readFileSync","stack","stackTrace","parse","frame","wrapCallSite","getFileName","match","getErrorSource","name","topFrame","sourceContentFor","codeFrameColumns","start","line","getLineNumber","column","getColumnNumber","highlightCode","position","getPosition","getScriptNameOrSourceURL","toString","CallSiteToString","wasConverted","includes","slice","indexOf","replace","test","originalPositionFor","_this","self","fileLocation","isNative","isEval","getEvalOrigin","lineNumber","columnNumber","functionName","getFunctionName","addSuffix","isConstructor","methodName","getMethodName","typeName","getTypeName","isMethodCall","isToplevel","length"],"sources":["../../src/reporter/prepare-stack-trace.ts"],"sourcesContent":["/* Code borrowed and based on\n * https://github.com/evanw/node-source-map-support/blob/master/source-map-support.js\n */\n\nimport { readFileSync, readdirSync } from \"fs\"\nimport { codeFrameColumns } from \"@babel/code-frame\"\nimport stackTrace from \"stack-trace\"\nimport {\n  TraceMap,\n  originalPositionFor,\n  OriginalMapping,\n  InvalidOriginalMapping,\n  sourceContentFor,\n} from \"@jridgewell/trace-mapping\"\nimport * as path from \"path\"\n\nexport class ErrorWithCodeFrame extends Error {\n  codeFrame?: string = ``\n\n  constructor(error: Error) {\n    super(error.message)\n\n    // We must use getOwnProperty because keys like `stack` are not enumerable,\n    // but we want to copy over the entire error\n    Object.getOwnPropertyNames(error).forEach(key => {\n      this[key] = error[key]\n    })\n  }\n}\n\nexport function prepareStackTrace(\n  error: Error,\n  sourceOfMainMap: string\n): ErrorWithCodeFrame {\n  const newError = new ErrorWithCodeFrame(error)\n  // source point to single map, but with code splitting for build-html we need to handle more maps\n  // we use fact that all .map files will be in same dir as main one here\n  const bundleDir = path.dirname(sourceOfMainMap)\n  const bundleDirMapFiles = readdirSync(bundleDir)\n    .filter(fileName => fileName.endsWith(`.js.map`))\n    .map(fileName => path.join(bundleDir, fileName))\n\n  const maps = bundleDirMapFiles.map(\n    source => new TraceMap(readFileSync(source, `utf8`))\n  )\n\n  const stack = stackTrace\n    .parse(newError)\n    .map(frame => wrapCallSite(maps, frame))\n    .filter(\n      frame =>\n        `wasConverted` in frame &&\n        (!frame.getFileName() ||\n          !frame\n            .getFileName()\n            .match(/^webpack:\\/+(lib\\/)?(webpack\\/|\\.cache\\/)/))\n    )\n\n  newError.codeFrame = getErrorSource(maps, stack[0])\n  newError.stack =\n    `${newError.name}: ${newError.message}\\n` +\n    stack.map(frame => `    at ${frame}`).join(`\\n`)\n\n  return newError\n}\n\nfunction getErrorSource(\n  maps: Array<TraceMap>,\n  topFrame: stackTrace.StackFrame | IWrappedStackFrame\n): string {\n  let source\n  for (const map of maps) {\n    source = sourceContentFor(map, topFrame.getFileName())\n    if (source) {\n      break\n    }\n  }\n\n  return source\n    ? codeFrameColumns(\n        source,\n        {\n          start: {\n            line: topFrame.getLineNumber(),\n            column: topFrame.getColumnNumber(),\n          },\n        },\n        {\n          highlightCode: true,\n        }\n      )\n    : ``\n}\n\ninterface IWrappedStackFrame {\n  getFileName(): string\n  getLineNumber(): number\n  getColumnNumber(): number\n  getScriptNameOrSourceURL(): string\n  toString: typeof CallSiteToString\n  wasConverted: true\n}\n\nfunction wrapCallSite(\n  maps: Array<TraceMap>,\n  frame: stackTrace.StackFrame\n): IWrappedStackFrame | stackTrace.StackFrame {\n  const source = frame.getFileName()\n  if (!source) return frame\n\n  const position = getPosition({ maps, frame })\n  if (!position.source) return frame\n\n  return {\n    getFileName: (): string => position.source || ``,\n    getLineNumber: (): number => position.line || 0,\n    getColumnNumber: (): number => (position.column || 0) + 1,\n    getScriptNameOrSourceURL: (): string => position.source || ``,\n    toString: CallSiteToString,\n    wasConverted: true,\n  }\n}\n\nfunction getPosition({\n  maps,\n  frame,\n}: {\n  maps: Array<TraceMap>\n  frame: stackTrace.StackFrame\n}): OriginalMapping | InvalidOriginalMapping {\n  if (frame.getFileName().includes(`webpack:`)) {\n    // if source-map-register is initiated, stack traces would already be converted\n    return {\n      column: frame.getColumnNumber() - 1,\n      line: frame.getLineNumber(),\n      source: frame\n        .getFileName()\n        .slice(frame.getFileName().indexOf(`webpack:`))\n        .replace(/webpack:\\/+/g, `webpack://`),\n      name: null,\n    }\n  }\n\n  const line = frame.getLineNumber()\n  const column = frame.getColumnNumber()\n  for (const map of maps) {\n    const test = originalPositionFor(map, { line, column })\n    if (test.source) {\n      return test\n    }\n  }\n\n  return { source: null, column: null, line: null, name: null }\n}\n\n// This is copied almost verbatim from the V8 source code at\n// https://code.google.com/p/v8/source/browse/trunk/src/messages.js.\nfunction CallSiteToString(): string {\n  // @ts-ignore\n  const _this = this // eslint-disable-line @typescript-eslint/no-this-alias\n  const self = _this as\n    | NodeJS.CallSite\n    | IWrappedStackFrame\n    | stackTrace.StackFrame\n\n  let fileName\n  let fileLocation = ``\n  if (`isNative` in self && self.isNative()) {\n    fileLocation = `native`\n  } else {\n    fileName =\n      (`getScriptNameOrSourceURL` in self && self.getScriptNameOrSourceURL()) ||\n      (`getFileName` in self && self.getFileName())\n\n    if (!fileName && `isEval` in self && self.isEval()) {\n      fileLocation = `${self.getEvalOrigin()}, `\n    }\n\n    if (fileName) {\n      fileLocation += fileName.replace(/^webpack:\\/+(lib\\/)?/, ``)\n    } else {\n      // Source code does not originate from a file and is not native, but we\n      // can still get the source position inside the source string, e.g. in\n      // an eval string.\n      fileLocation += `<anonymous>`\n    }\n    const lineNumber = `getLineNumber` in self ? self.getLineNumber() : null\n    if (lineNumber != null) {\n      fileLocation += `:${lineNumber}`\n      const columnNumber =\n        `getColumnNumber` in self ? self.getColumnNumber() : null\n      if (columnNumber) {\n        fileLocation += `:${columnNumber}`\n      }\n    }\n  }\n\n  let line = ``\n  const functionName = `getFunctionName` in self ? self.getFunctionName() : ``\n  let addSuffix = true\n  const isConstructor = `isConstructor` in self && self.isConstructor()\n  const methodName = `getMethodName` in self ? self.getMethodName() : ``\n  const typeName = `getTypeName` in self ? self.getTypeName() : ``\n  const isMethodCall =\n    methodName &&\n    !((`isToplevel` in self && self.isToplevel()) || isConstructor)\n  if (isMethodCall && functionName) {\n    if (typeName && functionName.indexOf(typeName) != 0) {\n      line += `${typeName}.`\n    }\n    line += functionName\n    if (\n      functionName.indexOf(`.` + methodName) !=\n      functionName.length - (methodName || ``).length - 1\n    ) {\n      line += ` [as ${methodName}]`\n    }\n  } else if (typeName && !functionName) {\n    line += typeName + `.` + (methodName || `<anonymous>`)\n  } else if (isConstructor) {\n    line += `new ` + (functionName || `<anonymous>`)\n  } else if (functionName) {\n    line += functionName\n  } else {\n    line += fileLocation\n    addSuffix = false\n  }\n  if (addSuffix) line += ` (${fileLocation})`\n  return line\n}\n"],"mappings":"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"}