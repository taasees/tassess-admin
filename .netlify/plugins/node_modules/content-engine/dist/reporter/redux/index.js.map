{"version":3,"file":"index.js","names":["store","createStore","combineReducers","logs","logsReducer","storeSwapListeners","onLogActionListeners","Set","getStore","diagnosticsMiddleware","createStructuredLoggingDiagnosticsMiddleware","dispatch","action","Array","isArray","forEach","item","timestamp","Date","toJSON","isInternalAction","fn","onStoreSwap","push","onLogAction","add","delete","setStore","s","type","Actions","SetLogs","payload","getState"],"sources":["../../../src/reporter/redux/index.ts"],"sourcesContent":["import { createStore, combineReducers, Store } from \"redux\"\nimport { reducer as logsReducer } from \"./reducers/logs\"\nimport { ActionsUnion, ISetLogs, IGatsbyCLIState } from \"./types\"\nimport { isInternalAction } from \"./utils\"\nimport { createStructuredLoggingDiagnosticsMiddleware } from \"./diagnostics\"\nimport { Actions } from \"../constants\"\nimport { IRenderPageArgs } from \"../types\"\n\nlet store: Store<{ logs: IGatsbyCLIState; pageTree: IRenderPageArgs }> =\n  createStore(\n    combineReducers({\n      logs: logsReducer,\n    }),\n    {}\n  )\n\nexport type GatsbyCLIStore = typeof store\ntype StoreListener = (store: GatsbyCLIStore) => void\ntype ActionLogListener = (action: ActionsUnion) => any\ntype Thunk = (...args: Array<any>) => ActionsUnion\n\nconst storeSwapListeners: Array<StoreListener> = []\nconst onLogActionListeners = new Set<ActionLogListener>()\n\nexport const getStore = (): typeof store => store\n\nconst diagnosticsMiddleware =\n  createStructuredLoggingDiagnosticsMiddleware(getStore)\n\nexport const dispatch = (action: ActionsUnion | Thunk): void => {\n  if (!action) {\n    return\n  }\n\n  if (Array.isArray(action)) {\n    action.forEach(item => dispatch(item))\n    return\n  } else if (typeof action === `function`) {\n    action(dispatch)\n    return\n  }\n\n  action = {\n    ...action,\n    // @ts-ignore this is a typescript no-no..\n    // And i'm pretty sure this timestamp isn't used anywhere.\n    // but for now, the structured logs integration tests expect it\n    // so it's easier to leave it and then explore as a follow up\n    timestamp: new Date().toJSON(),\n  } as ActionsUnion\n\n  store.dispatch(action)\n\n  diagnosticsMiddleware(action)\n\n  if (isInternalAction(action)) {\n    // consumers (ipc, yurnalist, json logger) shouldn't have to\n    // deal with actions needed just for internal tracking of status\n    return\n  }\n  for (const fn of onLogActionListeners) {\n    fn(action)\n  }\n}\n\nexport const onStoreSwap = (fn: StoreListener): void => {\n  storeSwapListeners.push(fn)\n}\n\nexport const onLogAction = (fn: ActionLogListener): (() => void) => {\n  onLogActionListeners.add(fn)\n\n  return (): void => {\n    onLogActionListeners.delete(fn)\n  }\n}\n\nexport const setStore = (s: GatsbyCLIStore): void => {\n  s.dispatch({\n    type: Actions.SetLogs,\n    payload: store.getState().logs,\n  } as ISetLogs)\n  store = s\n  storeSwapListeners.forEach(fn => fn(store))\n}\n"],"mappings":";;;;AAAA;AACA;AAEA;AACA;AACA;AAGA,IAAIA,KAAkE,GACpE,IAAAC,kBAAW,EACT,IAAAC,sBAAe,EAAC;EACdC,IAAI,EAAEC;AACR,CAAC,CAAC,EACF,CAAC,CAAC,CACH;AAOH,MAAMC,kBAAwC,GAAG,EAAE;AACnD,MAAMC,oBAAoB,GAAG,IAAIC,GAAG,EAAqB;AAElD,MAAMC,QAAQ,GAAG,MAAoBR,KAAK;AAAA;AAEjD,MAAMS,qBAAqB,GACzB,IAAAC,yDAA4C,EAACF,QAAQ,CAAC;AAEjD,MAAMG,QAAQ,GAAIC,MAA4B,IAAW;EAC9D,IAAI,CAACA,MAAM,EAAE;IACX;EACF;EAEA,IAAIC,KAAK,CAACC,OAAO,CAACF,MAAM,CAAC,EAAE;IACzBA,MAAM,CAACG,OAAO,CAACC,IAAI,IAAIL,QAAQ,CAACK,IAAI,CAAC,CAAC;IACtC;EACF,CAAC,MAAM,IAAI,OAAOJ,MAAM,KAAM,UAAS,EAAE;IACvCA,MAAM,CAACD,QAAQ,CAAC;IAChB;EACF;EAEAC,MAAM,GAAG;IACP,GAAGA,MAAM;IACT;IACA;IACA;IACA;IACAK,SAAS,EAAE,IAAIC,IAAI,EAAE,CAACC,MAAM;EAC9B,CAAiB;EAEjBnB,KAAK,CAACW,QAAQ,CAACC,MAAM,CAAC;EAEtBH,qBAAqB,CAACG,MAAM,CAAC;EAE7B,IAAI,IAAAQ,uBAAgB,EAACR,MAAM,CAAC,EAAE;IAC5B;IACA;IACA;EACF;EACA,KAAK,MAAMS,EAAE,IAAIf,oBAAoB,EAAE;IACrCe,EAAE,CAACT,MAAM,CAAC;EACZ;AACF,CAAC;AAAA;AAEM,MAAMU,WAAW,GAAID,EAAiB,IAAW;EACtDhB,kBAAkB,CAACkB,IAAI,CAACF,EAAE,CAAC;AAC7B,CAAC;AAAA;AAEM,MAAMG,WAAW,GAAIH,EAAqB,IAAmB;EAClEf,oBAAoB,CAACmB,GAAG,CAACJ,EAAE,CAAC;EAE5B,OAAO,MAAY;IACjBf,oBAAoB,CAACoB,MAAM,CAACL,EAAE,CAAC;EACjC,CAAC;AACH,CAAC;AAAA;AAEM,MAAMM,QAAQ,GAAIC,CAAiB,IAAW;EACnDA,CAAC,CAACjB,QAAQ,CAAC;IACTkB,IAAI,EAAEC,kBAAO,CAACC,OAAO;IACrBC,OAAO,EAAEhC,KAAK,CAACiC,QAAQ,EAAE,CAAC9B;EAC5B,CAAC,CAAa;EACdH,KAAK,GAAG4B,CAAC;EACTvB,kBAAkB,CAACU,OAAO,CAACM,EAAE,IAAIA,EAAE,CAACrB,KAAK,CAAC,CAAC;AAC7C,CAAC;AAAA"}