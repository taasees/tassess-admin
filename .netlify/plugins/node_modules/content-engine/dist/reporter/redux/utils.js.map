{"version":3,"file":"utils.js","names":["isActivityInProgress","activityStatus","ActivityStatuses","InProgress","NotStarted","getGlobalStatus","id","status","logs","getStore","getState","currentActivities","Object","keys","activities","reduce","generatedStatus","activityId","Failed","Interrupted","Success","getActivity","getElapsedTimeMS","activity","elapsed","process","hrtime","startTime","convertHrtime","milliseconds","isInternalAction","action","type","Actions","PendingActivity","CancelActivity","ActivityErrored","StartActivity","EndActivity","payload","ActivityTypes","Hidden","delayedCall","fn","timeout","fnWrap","clear","timeoutID","setTimeout","cancelSignalExit","signalExit","clearTimeout"],"sources":["../../../src/reporter/redux/utils.ts"],"sourcesContent":["import { getStore } from \"./index\"\nimport convertHrtime from \"convert-hrtime\"\nimport { Actions, ActivityTypes, ActivityStatuses } from \"../constants\"\nimport { ActionsUnion, IActivity } from \"./types\"\nimport signalExit from \"signal-exit\"\n\nexport function isActivityInProgress(\n  activityStatus: ActivityStatuses\n): boolean {\n  return (\n    activityStatus === ActivityStatuses.InProgress ||\n    activityStatus === ActivityStatuses.NotStarted\n  )\n}\n\nexport const getGlobalStatus = (\n  id: string,\n  status: ActivityStatuses\n): ActivityStatuses => {\n  const { logs } = getStore().getState()\n\n  const currentActivities = [id, ...Object.keys(logs.activities)]\n\n  return currentActivities.reduce(\n    (\n      generatedStatus: ActivityStatuses,\n      activityId: string\n    ): ActivityStatuses => {\n      const activityStatus =\n        activityId === id ? status : logs.activities[activityId].status\n\n      if (isActivityInProgress(activityStatus)) {\n        return ActivityStatuses.InProgress\n      } else if (\n        activityStatus === ActivityStatuses.Failed &&\n        generatedStatus !== ActivityStatuses.InProgress\n      ) {\n        return ActivityStatuses.Failed\n      } else if (\n        activityStatus === ActivityStatuses.Interrupted &&\n        generatedStatus !== ActivityStatuses.InProgress\n      ) {\n        return ActivityStatuses.Interrupted\n      }\n      return generatedStatus\n    },\n    ActivityStatuses.Success\n  )\n}\n\nexport const getActivity = (id: string): IActivity | null =>\n  getStore().getState().logs.activities[id]\n\n/**\n * @returns {Number} Milliseconds from activity start\n */\nexport const getElapsedTimeMS = (activity: IActivity): number => {\n  const elapsed = process.hrtime(activity.startTime)\n  return convertHrtime(elapsed).milliseconds\n}\n\nexport const isInternalAction = (action: ActionsUnion): boolean => {\n  switch (action.type) {\n    case Actions.PendingActivity:\n    case Actions.CancelActivity:\n    case Actions.ActivityErrored:\n      return true\n    case Actions.StartActivity:\n    case Actions.EndActivity:\n      return action.payload.type === ActivityTypes.Hidden\n    default:\n      return false\n  }\n}\n\n/**\n * Like setTimeout, but also handle signalExit\n */\nexport const delayedCall = (fn: () => void, timeout: number): (() => void) => {\n  const fnWrap = (): void => {\n    fn()\n    // eslint-disable-next-line @typescript-eslint/no-use-before-define\n    clear()\n  }\n\n  const timeoutID = setTimeout(fnWrap, timeout)\n  const cancelSignalExit = signalExit(fnWrap)\n\n  const clear = (): void => {\n    clearTimeout(timeoutID)\n    cancelSignalExit()\n  }\n\n  return clear\n}\n"],"mappings":";;;;;;;AAAA;AACA;AACA;AAEA;AAEO,SAASA,oBAAoB,CAClCC,cAAgC,EACvB;EACT,OACEA,cAAc,KAAKC,2BAAgB,CAACC,UAAU,IAC9CF,cAAc,KAAKC,2BAAgB,CAACE,UAAU;AAElD;AAEO,MAAMC,eAAe,GAAG,CAC7BC,EAAU,EACVC,MAAwB,KACH;EACrB,MAAM;IAAEC;EAAK,CAAC,GAAG,IAAAC,eAAQ,GAAE,CAACC,QAAQ,EAAE;EAEtC,MAAMC,iBAAiB,GAAG,CAACL,EAAE,EAAE,GAAGM,MAAM,CAACC,IAAI,CAACL,IAAI,CAACM,UAAU,CAAC,CAAC;EAE/D,OAAOH,iBAAiB,CAACI,MAAM,CAC7B,CACEC,eAAiC,EACjCC,UAAkB,KACG;IACrB,MAAMhB,cAAc,GAClBgB,UAAU,KAAKX,EAAE,GAAGC,MAAM,GAAGC,IAAI,CAACM,UAAU,CAACG,UAAU,CAAC,CAACV,MAAM;IAEjE,IAAIP,oBAAoB,CAACC,cAAc,CAAC,EAAE;MACxC,OAAOC,2BAAgB,CAACC,UAAU;IACpC,CAAC,MAAM,IACLF,cAAc,KAAKC,2BAAgB,CAACgB,MAAM,IAC1CF,eAAe,KAAKd,2BAAgB,CAACC,UAAU,EAC/C;MACA,OAAOD,2BAAgB,CAACgB,MAAM;IAChC,CAAC,MAAM,IACLjB,cAAc,KAAKC,2BAAgB,CAACiB,WAAW,IAC/CH,eAAe,KAAKd,2BAAgB,CAACC,UAAU,EAC/C;MACA,OAAOD,2BAAgB,CAACiB,WAAW;IACrC;IACA,OAAOH,eAAe;EACxB,CAAC,EACDd,2BAAgB,CAACkB,OAAO,CACzB;AACH,CAAC;AAAA;AAEM,MAAMC,WAAW,GAAIf,EAAU,IACpC,IAAAG,eAAQ,GAAE,CAACC,QAAQ,EAAE,CAACF,IAAI,CAACM,UAAU,CAACR,EAAE,CAAC;;AAE3C;AACA;AACA;AAFA;AAGO,MAAMgB,gBAAgB,GAAIC,QAAmB,IAAa;EAC/D,MAAMC,OAAO,GAAGC,OAAO,CAACC,MAAM,CAACH,QAAQ,CAACI,SAAS,CAAC;EAClD,OAAO,IAAAC,sBAAa,EAACJ,OAAO,CAAC,CAACK,YAAY;AAC5C,CAAC;AAAA;AAEM,MAAMC,gBAAgB,GAAIC,MAAoB,IAAc;EACjE,QAAQA,MAAM,CAACC,IAAI;IACjB,KAAKC,kBAAO,CAACC,eAAe;IAC5B,KAAKD,kBAAO,CAACE,cAAc;IAC3B,KAAKF,kBAAO,CAACG,eAAe;MAC1B,OAAO,IAAI;IACb,KAAKH,kBAAO,CAACI,aAAa;IAC1B,KAAKJ,kBAAO,CAACK,WAAW;MACtB,OAAOP,MAAM,CAACQ,OAAO,CAACP,IAAI,KAAKQ,wBAAa,CAACC,MAAM;IACrD;MACE,OAAO,KAAK;EAAA;AAElB,CAAC;;AAED;AACA;AACA;AAFA;AAGO,MAAMC,WAAW,GAAG,CAACC,EAAc,EAAEC,OAAe,KAAmB;EAC5E,MAAMC,MAAM,GAAG,MAAY;IACzBF,EAAE,EAAE;IACJ;IACAG,KAAK,EAAE;EACT,CAAC;EAED,MAAMC,SAAS,GAAGC,UAAU,CAACH,MAAM,EAAED,OAAO,CAAC;EAC7C,MAAMK,gBAAgB,GAAG,IAAAC,mBAAU,EAACL,MAAM,CAAC;EAE3C,MAAMC,KAAK,GAAG,MAAY;IACxBK,YAAY,CAACJ,SAAS,CAAC;IACvBE,gBAAgB,EAAE;EACpB,CAAC;EAED,OAAOH,KAAK;AACd,CAAC;AAAA"}