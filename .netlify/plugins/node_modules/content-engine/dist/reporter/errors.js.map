{"version":3,"file":"errors.js","names":["packagesToSkip","packagesToSkipTest","RegExp","join","sanitizeStructuredStackTrace","stack","filter","callSite","getFileName","test","includes","isNodeInternalModulePath","map","fileName","functionName","getFunctionName","columnNumber","getColumnNumber","lineNumber","getLineNumber","getErrorFormatter","prettyError","PrettyError","baseRender","render","skipNodeFiles","skipPackage","skip","traceLine","file","appendStyle","marginTop","background","color","process","env","FORCE_COLOR","withoutColors","err","Array","isArray","e","rendered","call","codeFrame","createErrorFromString","errorOrErrorStack","sourceMapFile","errorStr","message","rest","split","replace","error","Error","name","prepareStackTrace","forcedLocation","source","readFileSync","codeFrameColumns","start","line","column","end","endColumnNumber","endLineNumber","undefined","highlightCode"],"sources":["../../src/reporter/errors.ts"],"sourcesContent":["import PrettyError from \"pretty-error\"\nimport stackTrace from \"stack-trace\"\nimport { prepareStackTrace, ErrorWithCodeFrame } from \"./prepare-stack-trace\"\nimport { isNodeInternalModulePath } from \"../core-utils\"\nimport { IStructuredStackFrame } from \"../structured-errors/types\"\nimport { readFileSync } from \"fs-extra\"\nimport { codeFrameColumns } from \"@babel/code-frame\"\n\nconst packagesToSkip = [`core-js`, `bluebird`, `regenerator-runtime`, `graphql`]\n\nconst packagesToSkipTest = new RegExp(\n  `node_modules[\\\\/](${packagesToSkip.join(`|`)})`\n)\n\n// TO-DO: move this this out of this file (and probably delete this file completely)\n// it's here because it re-implements similar thing as `pretty-error` already does\nexport const sanitizeStructuredStackTrace = (\n  stack: Array<stackTrace.StackFrame>\n): Array<IStructuredStackFrame> => {\n  // first filter out not useful call sites\n  stack = stack.filter(callSite => {\n    if (!callSite.getFileName()) {\n      return false\n    }\n\n    if (packagesToSkipTest.test(callSite.getFileName())) {\n      return false\n    }\n\n    if (callSite.getFileName().includes(`asyncToGenerator.js`)) {\n      return false\n    }\n\n    if (isNodeInternalModulePath(callSite.getFileName())) {\n      return false\n    }\n\n    return true\n  })\n\n  // then sanitize individual call site objects to make sure we don't\n  // emit objects with extra fields that won't be handled by consumers\n  return stack.map(callSite => {\n    return {\n      fileName: callSite.getFileName(),\n      functionName: callSite.getFunctionName(),\n      columnNumber: callSite.getColumnNumber(),\n      lineNumber: callSite.getLineNumber(),\n    }\n  })\n}\n\ntype PrettyRenderError = Error | ErrorWithCodeFrame\n\nexport function getErrorFormatter(): PrettyError {\n  const prettyError = new PrettyError()\n  const baseRender = prettyError.render\n\n  prettyError.skipNodeFiles()\n  prettyError.skipPackage(\n    `regenerator-runtime`,\n    `graphql`,\n    `core-js`\n    // `static-site-generator-webpack-plugin`,\n    // `tapable`, // webpack\n  )\n\n  // @ts-ignore the type defs in prettyError are wrong\n  prettyError.skip((traceLine: any) => {\n    if (traceLine && traceLine.file === `asyncToGenerator.js`) return true\n    return false\n  })\n\n  prettyError.appendStyle({\n    \"pretty-error\": {\n      marginTop: 1,\n    },\n    \"pretty-error > header\": {\n      background: `red`,\n    },\n    \"pretty-error > header > colon\": {\n      color: `white`,\n    },\n  })\n\n  if (process.env.FORCE_COLOR === `0`) {\n    prettyError.withoutColors()\n  }\n\n  prettyError.render = (\n    err: PrettyRenderError | Array<PrettyRenderError>\n  ): string => {\n    if (Array.isArray(err)) {\n      return err.map(e => prettyError.render(e)).join(`\\n`)\n    }\n\n    let rendered = baseRender.call(prettyError, err)\n    if (`codeFrame` in err) rendered = `\\n${err.codeFrame}\\n${rendered}`\n    return rendered\n  }\n  return prettyError\n}\n\ntype ErrorWithPotentialForcedLocation = Error & {\n  forcedLocation?: {\n    fileName: string\n    lineNumber?: number\n    columnNumber?: number\n    endLineNumber?: number\n    endColumnNumber?: number\n    functionName?: string\n  }\n}\n\n/**\n * Convert a stringified webpack compilation error back into\n * an Error instance so it can be formatted properly\n */\nexport function createErrorFromString(\n  errorOrErrorStack: string | ErrorWithPotentialForcedLocation = ``,\n  sourceMapFile: string\n): ErrorWithCodeFrame {\n  if (typeof errorOrErrorStack === `string`) {\n    const errorStr = errorOrErrorStack\n    let [message, ...rest] = errorStr.split(/\\r\\n|[\\n\\r]/g)\n    // pull the message from the first line then remove the `Error:` prefix\n    // FIXME: when https://github.com/AriaMinaei/pretty-error/pull/49 is merged\n\n    message = message.replace(/^(Error:)/, ``)\n\n    const error = new Error(message)\n\n    error.stack = [message, rest.join(`\\n`)].join(`\\n`)\n\n    error.name = `WebpackError`\n    try {\n      if (sourceMapFile) {\n        return prepareStackTrace(error, sourceMapFile)\n      }\n    } catch (err) {\n      // don't shadow a real error because of a parsing issue\n    }\n    return error\n  } else {\n    if (errorOrErrorStack.forcedLocation) {\n      const forcedLocation = errorOrErrorStack.forcedLocation\n      const error = new Error(errorOrErrorStack.message) as ErrorWithCodeFrame\n      error.stack = `${errorOrErrorStack.message}\n  at ${forcedLocation.functionName ?? `<anonymous>`} (${\n        forcedLocation.fileName\n      }${\n        forcedLocation.lineNumber\n          ? `:${forcedLocation.lineNumber}${\n              forcedLocation.columnNumber\n                ? `:${forcedLocation.columnNumber}`\n                : ``\n            }`\n          : ``\n      })`\n\n      try {\n        const source = readFileSync(forcedLocation.fileName, `utf8`)\n\n        error.codeFrame = codeFrameColumns(\n          source,\n          {\n            start: {\n              line: forcedLocation.lineNumber ?? 0,\n              column: forcedLocation.columnNumber ?? 0,\n            },\n            end: forcedLocation.endColumnNumber\n              ? {\n                  line: forcedLocation.endLineNumber ?? 0,\n                  column: forcedLocation.endColumnNumber ?? 0,\n                }\n              : undefined,\n          },\n          {\n            highlightCode: true,\n          }\n        )\n      } catch (e) {\n        // failed to generate codeframe, we still should show an error so we keep going\n      }\n\n      return error\n    } else {\n      return createErrorFromString(errorOrErrorStack.stack, sourceMapFile)\n    }\n  }\n}\n"],"mappings":"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"}