{"version":3,"file":"get-config-file.js","names":["getConfigFile","siteDirectory","configName","distance","uncompiledResult","attemptImportUncompiled","attemptImport","configPath","configFilePath","resolveJSFilepath","rootDir","filePath","configModule","undefined","maybeAddFileProtocol","importedModule","preferDefault","uncompiledConfigPath","path","join","error","testImportError","report","panic","id","context","message","Error","tsConfig","nearMatch","checkTsAndNearMatch","isTSX","endsWith","isInSrcDir","warn","files","fs","readdir","file","name","ext","parse","isNearMatch"],"sources":["../../src/bootstrap/get-config-file.ts"],"sourcesContent":["import fs from \"fs-extra\"\nimport { testImportError } from \"../utils/test-import-error\"\nimport report from \"../reporter\"\nimport path from \"path\"\nimport { isNearMatch } from \"../utils/is-near-match\"\nimport { resolveJSFilepath, maybeAddFileProtocol } from \"./resolve-js-file-path\"\nimport { preferDefault } from \"./prefer-default\"\n\nexport async function getConfigFile(\n  siteDirectory: string,\n  configName: string,\n  distance: number = 3\n): Promise<{\n  configModule: any\n  configFilePath: string\n}> {\n  const uncompiledResult = await attemptImportUncompiled(\n    siteDirectory,\n    configName,\n    distance\n  )\n\n  return uncompiledResult || {}\n}\n\nasync function attemptImport(\n  siteDirectory: string,\n  configPath: string\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  const configFilePath = await resolveJSFilepath({\n    rootDir: siteDirectory,\n    filePath: configPath,\n  })\n\n  // The file does not exist, no sense trying to import it\n  if (!configFilePath) {\n    return { configFilePath: ``, configModule: undefined }\n  }\n\n  const filePath = maybeAddFileProtocol(configFilePath)\n  const importedModule = await import(filePath)\n  const configModule = preferDefault(importedModule)\n\n  return { configFilePath, configModule }\n}\n\nasync function attemptImportUncompiled(\n  siteDirectory: string,\n  configName: string,\n  distance: number\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  let uncompiledResult\n\n  const uncompiledConfigPath = path.join(siteDirectory, configName)\n\n  try {\n    uncompiledResult = await attemptImport(siteDirectory, uncompiledConfigPath)\n  } catch (error) {\n    if (!testImportError(uncompiledConfigPath, error)) {\n      report.panic({\n        id: `10123`,\n        error,\n        context: {\n          configName,\n          message: error.message,\n        },\n      })\n    }\n  }\n\n  if (uncompiledResult?.configFilePath) {\n    return uncompiledResult\n  }\n\n  const error = new Error(`Cannot find package '${uncompiledConfigPath}'`)\n\n  const { tsConfig, nearMatch } = await checkTsAndNearMatch(\n    siteDirectory,\n    configName,\n    distance\n  )\n\n  // gatsby-config.ts exists but compiled gatsby-config.js does not\n  if (tsConfig) {\n    report.panic({\n      id: `10127`,\n      error,\n      context: {\n        configName,\n      },\n    })\n  }\n\n  // gatsby-config is misnamed\n  if (nearMatch) {\n    const isTSX = nearMatch.endsWith(`.tsx`)\n    report.panic({\n      id: `10124`,\n      error,\n      context: {\n        configName,\n        nearMatch,\n        isTSX,\n      },\n    })\n  }\n\n  // gatsby-config is incorrectly located in src directory\n  const isInSrcDir = await resolveJSFilepath({\n    rootDir: siteDirectory,\n    filePath: path.join(siteDirectory, `src`, configName),\n    warn: false,\n  })\n\n  if (isInSrcDir) {\n    report.panic({\n      id: `10125`,\n      context: {\n        configName,\n      },\n    })\n  }\n\n  return uncompiledResult\n}\n\nasync function checkTsAndNearMatch(\n  siteDirectory: string,\n  configName: string,\n  distance: number\n): Promise<{\n  tsConfig: boolean\n  nearMatch: string\n}> {\n  const files = await fs.readdir(siteDirectory)\n\n  let tsConfig = false\n  let nearMatch = ``\n\n  for (const file of files) {\n    if (tsConfig || nearMatch) {\n      break\n    }\n\n    const { name, ext } = path.parse(file)\n\n    if (name === configName && ext === `.ts`) {\n      tsConfig = true\n      break\n    }\n\n    if (isNearMatch(name, configName, distance)) {\n      nearMatch = file\n    }\n  }\n\n  return {\n    tsConfig,\n    nearMatch,\n  }\n}\n"],"mappings":"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"}