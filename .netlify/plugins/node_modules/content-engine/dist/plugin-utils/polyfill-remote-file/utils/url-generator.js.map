{"version":3,"file":"url-generator.js","names":["ORIGIN","ImageCDNUrlKeys","encryptImageCdnUrl","secretKey","iv","urlToEncrypt","randomPadding","crypto","randomBytes","randomInt","toString","toEncrypt","cipher","createCipheriv","Buffer","from","encrypted","update","finalBuffer","concat","final","appendUrlParamToSearchParams","searchParams","url","key","process","env","IMAGE_CDN_ENCRYPTION_SECRET_KEY","IMAGE_CDN_ENCRYPTION_IV","shouldEncrypt","paramName","ENCRYPTED_URL","URL","finalUrl","append","generateFileUrl","filename","store","fileExt","extname","filenameWithoutExt","basename","parsedURL","generatePublicUrl","pathname","search","generateImageUrl","source","imageArgs","queryStr","generateImageArgs","createContentDigest","format","ARGS","CONTENT_DIGEST","internal","contentDigest","mimeType","state","getState","pathPrefix","program","prefixPaths","config","remoteUrl","publicUrl","isImage","width","height","cropFocus","quality","args","push","Array","isArray","join"],"sources":["../../../../src/plugin-utils/polyfill-remote-file/utils/url-generator.ts"],"sourcesContent":["import crypto from \"crypto\"\nimport { basename, extname } from \"path\"\nimport { URL } from \"url\"\nimport { createContentDigest } from \"../../../core-utils/create-content-digest\"\nimport { isImage } from \"../types\"\nimport type { ImageCropFocus, WidthOrHeight } from \"../types\"\nimport type { Store } from \"../../../types\"\n\n// this is an arbitrary origin that we use #branding so we can construct a full url for the URL constructor\nconst ORIGIN = `https://gatsbyjs.com`\n\nexport enum ImageCDNUrlKeys {\n  URL = `u`,\n  ENCRYPTED_URL = `eu`,\n  ARGS = `a`,\n  CONTENT_DIGEST = `cd`,\n}\n\nfunction encryptImageCdnUrl(\n  secretKey: string,\n  iv: string,\n  urlToEncrypt: string\n): string {\n  const randomPadding = crypto\n    .randomBytes(crypto.randomInt(32, 64))\n    .toString(`hex`)\n\n  const toEncrypt = `${randomPadding}:${urlToEncrypt}`\n  const cipher = crypto.createCipheriv(\n    `aes-256-ctr`,\n    Buffer.from(secretKey, `hex`),\n    Buffer.from(iv, `hex`)\n  )\n  const encrypted = cipher.update(toEncrypt)\n  const finalBuffer = Buffer.concat([encrypted, cipher.final()])\n\n  return finalBuffer.toString(`hex`)\n}\n\nfunction appendUrlParamToSearchParams(\n  searchParams: URLSearchParams,\n  url: string\n): void {\n  const key = process.env.IMAGE_CDN_ENCRYPTION_SECRET_KEY || ``\n  const iv = process.env.IMAGE_CDN_ENCRYPTION_IV || ``\n  const shouldEncrypt = !!(iv && key)\n\n  const paramName = shouldEncrypt\n    ? ImageCDNUrlKeys.ENCRYPTED_URL\n    : ImageCDNUrlKeys.URL\n\n  const finalUrl = shouldEncrypt ? encryptImageCdnUrl(key, iv, url) : url\n\n  searchParams.append(paramName, finalUrl)\n}\n\nexport function generateFileUrl(\n  {\n    url,\n    filename,\n  }: {\n    url: string\n    filename: string\n  },\n  store?: Store\n): string {\n  const fileExt = extname(filename)\n  const filenameWithoutExt = basename(filename, fileExt)\n\n  const parsedURL = new URL(\n    `${ORIGIN}${generatePublicUrl(\n      {\n        url,\n      },\n      store\n    )}/${filenameWithoutExt}${fileExt}`\n  )\n\n  appendUrlParamToSearchParams(parsedURL.searchParams, url)\n\n  return `${parsedURL.pathname}${parsedURL.search}`\n}\n\nexport function generateImageUrl(\n  source: {\n    url: string\n    mimeType: string\n    filename: string\n    internal: { contentDigest: string }\n  },\n  imageArgs: Parameters<typeof generateImageArgs>[0],\n  store?: Store\n): string {\n  const filenameWithoutExt = basename(source.filename, extname(source.filename))\n  const queryStr = generateImageArgs(imageArgs)\n\n  const parsedURL = new URL(\n    `${ORIGIN}${generatePublicUrl(source, store)}/${createContentDigest(\n      queryStr\n    )}/${filenameWithoutExt}.${imageArgs.format}`\n  )\n\n  appendUrlParamToSearchParams(parsedURL.searchParams, source.url)\n  parsedURL.searchParams.append(ImageCDNUrlKeys.ARGS, queryStr)\n  parsedURL.searchParams.append(\n    ImageCDNUrlKeys.CONTENT_DIGEST,\n    source.internal.contentDigest\n  )\n\n  return `${parsedURL.pathname}${parsedURL.search}`\n}\n\nfunction generatePublicUrl(\n  {\n    url,\n    mimeType,\n  }: {\n    url: string\n    mimeType?: string\n  },\n  store?: Store\n): string {\n  const state = store?.getState()\n\n  // @ts-ignore\n  const pathPrefix = state?.program?.prefixPaths\n    ? // @ts-ignore\n      state?.config?.pathPrefix\n    : ``\n\n  const remoteUrl = createContentDigest(url)\n\n  let publicUrl =\n    pathPrefix +\n    (mimeType && isImage({ mimeType }) ? `/_gatsby/image/` : `/_gatsby/file/`)\n\n  publicUrl += `${remoteUrl}`\n\n  return publicUrl\n}\n\nfunction generateImageArgs({\n  width,\n  height,\n  format,\n  cropFocus,\n  quality,\n}: WidthOrHeight & {\n  format: string\n  cropFocus?: ImageCropFocus | Array<ImageCropFocus>\n  quality: number\n}): string {\n  const args: Array<string> = []\n  if (width) {\n    args.push(`w=${width}`)\n  }\n  if (height) {\n    args.push(`h=${height}`)\n  }\n  if (cropFocus) {\n    args.push(`fit=crop`)\n    args.push(\n      `crop=${Array.isArray(cropFocus) ? cropFocus.join(`,`) : cropFocus}`\n    )\n  }\n  args.push(`fm=${format}`)\n  args.push(`q=${quality}`)\n\n  return args.join(`&`)\n}\n"],"mappings":"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"}