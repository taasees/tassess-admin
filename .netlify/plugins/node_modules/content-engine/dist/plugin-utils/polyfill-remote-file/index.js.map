{"version":3,"file":"index.js","names":["enums","getRemoteFileFields","actions","store","id","mimeType","filename","filesize","width","height","publicUrl","generatePublicUrlFieldConfig","resize","generateResizeFieldConfig","gatsbyImage","generateGatsbyImageFieldConfig","addRemoteFilePolyfillInterface","type","schema","hasFeature","config","interfaces","includes","push","composer","SchemaComposer","getRemoteFileEnums","createEnumTC","bind","types","key","buildEnumType","name","getTypeName","values","getFields","buildObjectType","fields","src","buildInterfaceType","createTypes","version","getGatsbyVersion","resolve","path","join","__dirname","isImageCdnEnabled","process","env","GATSBY_CLOUD_IMAGE_CDN"],"sources":["../../../src/plugin-utils/polyfill-remote-file/index.ts"],"sourcesContent":["import path from \"path\"\nimport { SchemaComposer } from \"graphql-compose\"\nimport { getRemoteFileEnums } from \"./graphql/get-remote-file-enums\"\nimport { getGatsbyVersion } from \"./utils/get-gatsby-version\"\nimport { hasFeature } from \"../has-feature\"\nimport {\n  generatePublicUrlFieldConfig,\n  publicUrlResolver,\n} from \"./graphql/public-url-resolver\"\nimport {\n  generateResizeFieldConfig,\n  resizeResolver,\n} from \"./graphql/resize-resolver\"\nimport {\n  generateGatsbyImageFieldConfig,\n  gatsbyImageResolver,\n} from \"./graphql/gatsby-image-resolver\"\n\nimport type { Actions, Store } from \"../../types\"\nimport type { InterfaceTypeComposerAsObjectDefinition } from \"graphql-compose\"\nimport type { SchemaBuilder, IRemoteFileNode } from \"./types\"\n\nlet enums: ReturnType<typeof getRemoteFileEnums> | undefined\n\nexport function getRemoteFileFields(\n  enums: ReturnType<typeof getRemoteFileEnums>,\n  actions: Actions,\n  store?: Store\n): Record<string, unknown> {\n  return {\n    id: `ID!`,\n    mimeType: `String!`,\n    filename: `String!`,\n    filesize: `Int`,\n    width: `Int`,\n    height: `Int`,\n    publicUrl: generatePublicUrlFieldConfig(actions, store),\n    resize: generateResizeFieldConfig(enums, actions, store),\n    gatsbyImage: generateGatsbyImageFieldConfig(enums, actions, store),\n  }\n}\n\nfunction addRemoteFilePolyfillInterface<\n  T = ReturnType<SchemaBuilder[\"buildObjectType\"]>\n>(\n  type: T,\n  {\n    schema,\n    actions,\n    store,\n  }: {\n    schema: SchemaBuilder\n    actions: Actions\n    store: Store\n  }\n): T {\n  // When the image-cdn is part of Gatsby we will only add the RemoteFile interface if necessary\n  if (hasFeature(`image-cdn`)) {\n    // @ts-ignore - wrong typing by typecomposer\n    if (!type.config.interfaces.includes(`RemoteFile`)) {\n      // @ts-ignore - wrong typing by typecomposer\n      type.config.interfaces.push(`RemoteFile`)\n    }\n\n    return type\n  }\n\n  if (!enums) {\n    // We only want to create the enums and interface once\n    const composer = new SchemaComposer()\n    enums = getRemoteFileEnums(composer.createEnumTC.bind(composer))\n\n    const types: Array<\n      | string\n      | ReturnType<SchemaBuilder[\"buildObjectType\"]>\n      | ReturnType<SchemaBuilder[\"buildInterfaceType\"]>\n      | ReturnType<SchemaBuilder[\"buildEnumType\"]>\n    > = []\n\n    for (const key in enums) {\n      if (enums[key]) {\n        types.push(\n          schema.buildEnumType({\n            name: enums[key].getTypeName(),\n            values: enums[key].getFields(),\n          })\n        )\n      }\n    }\n\n    types.push(\n      schema.buildObjectType({\n        name: `RemoteFileResize`,\n        fields: {\n          width: `Int`,\n          height: `Int`,\n          src: `String`,\n        },\n      }),\n      schema.buildInterfaceType({\n        name: `RemoteFile`,\n        fields: getRemoteFileFields(\n          enums,\n          actions,\n          store\n        ) as InterfaceTypeComposerAsObjectDefinition<\n          IRemoteFileNode,\n          unknown\n        >[\"fields\"],\n      })\n    )\n\n    actions.createTypes(types, {\n      name: `gatsby`,\n      // @ts-ignore - version is allowed\n      version: getGatsbyVersion(),\n      resolve: path.join(__dirname, `../`),\n    })\n  }\n\n  // @ts-ignore - wrong typing by typecomposer\n  type.config.interfaces = type.config.interfaces || []\n  // @ts-ignore - wrong typing by typecomposer\n  if (!type.config.interfaces.includes(`RemoteFile`)) {\n    // @ts-ignore - wrong typing by typecomposer\n    type.config.interfaces.push(`RemoteFile`)\n  }\n  // @ts-ignore - wrong typing by typecomposer\n  type.config.fields = {\n    // @ts-ignore - wrong typing by typecomposer\n    ...type.config.fields,\n    ...getRemoteFileFields(enums, actions, store),\n  }\n\n  return type\n}\n\nfunction isImageCdnEnabled(): boolean {\n  return (\n    process.env.GATSBY_CLOUD_IMAGE_CDN === `1` ||\n    process.env.GATSBY_CLOUD_IMAGE_CDN === `true`\n  )\n}\n\nexport { polyfillImageServiceDevRoutes, addImageRoutes } from \"./http-routes\"\nexport {\n  getRemoteFileEnums,\n  addRemoteFilePolyfillInterface,\n  gatsbyImageResolver,\n  resizeResolver,\n  publicUrlResolver,\n  isImageCdnEnabled,\n}\n"],"mappings":"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"}